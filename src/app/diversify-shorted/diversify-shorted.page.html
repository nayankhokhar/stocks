<ion-header [translucent]="true" class="ion-no-border">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/"></ion-back-button>
    </ion-buttons>
    <ion-title>Diversify Shorted</ion-title>
    <ion-buttons slot="end">
      <ion-toggle [(ngModel)]="showSimpleTable" color="secondary"></ion-toggle>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="ion-padding page-background">
  <div class="header-section">
    <h1>Market Insights</h1>
    <p>Analyze the best performing mutual funds.</p>
  </div>

  <div class="data-section" *ngIf="!isLoading && allFundsData.length > 0">
    <ion-card class="table-card" *ngIf="!showSimpleTable">
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th rowspan="2">Fund Name</th>
              <th class="period-header">1 Year</th>
              <th class="period-header">3 Year</th>
              <th class="period-header">5 Year</th>
              <th class="period-header">Since Inception</th>
              <th rowspan="2">Yearly Returns</th>
            </tr>
            <tr class="sub-header-row">
              <!-- Sub-headers visually represented in content or just one header per block -->
              <!-- Let's just use the main header and stack content -->
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let fund of allFundsData">
              <td class="fund-name-cell">
                <div class="fund-name">{{ fund.name }}</div>
                <div class="fund-category" *ngIf="fund.meta">{{ fund.meta.scheme_category }}</div>
                <div class="fund-info-meta" style="font-size: 11px; color: #666; margin-top: 4px;">
                  Exp: {{ fund.expenseRatio }} | Exit: {{ fund.exitLoad }}
                </div>
              </td>

              <!-- 1 Year -->
              <td class="metrics-cell">
                <div class="metric-row">
                  <span class="label">Avg:</span>
                  <span class="value" [class.positive]="parseFloat(fund.performance?.oneYear?.avg || '0') > 0"
                    [class.negative]="parseFloat(fund.performance?.oneYear?.avg || '0') < 0">
                    {{ fund.performance?.oneYear?.avg }}
                  </span>
                </div>
                <div class="metric-row">
                  <span class="label">Abs:</span>
                  <span class="value" [class.positive]="parseFloat(fund.performance?.oneYear?.abs || '0') > 0"
                    [class.negative]="parseFloat(fund.performance?.oneYear?.abs || '0') < 0">
                    {{ fund.performance?.oneYear?.abs }}
                  </span>
                </div>
                <div class="metric-row">
                  <span class="label">Start:</span>
                  <span class="value">{{ fund.performance?.oneYear?.startNav }}</span>
                </div>
                <div class="metric-row">
                  <span class="label">End:</span>
                  <span class="value">{{ fund.performance?.oneYear?.endNav }}</span>
                </div>

                <!-- Daily SIP -->
                <div class="metric-group">
                  <div class="metric-row header">
                    <span class="label">dSIP(100):</span>
                    <span class="value">{{ fund.performance?.oneYear?.dailySip?.value }}</span>
                  </div>
                  <div class="metric-row sub">
                    <span class="label">Inv:</span>
                    <span class="value">{{ fund.performance?.oneYear?.dailySip?.investment }}</span>
                  </div>
                  <div class="metric-row sub">
                    <span class="label">Gain:</span>
                    <span class="value"
                      [class.positive]="parseFloat(fund.performance?.oneYear?.dailySip?.return || '0') > 0"
                      [class.negative]="parseFloat(fund.performance?.oneYear?.dailySip?.return || '0') < 0">
                      {{ fund.performance?.oneYear?.dailySip?.gain }} ({{ fund.performance?.oneYear?.dailySip?.return
                      }})
                    </span>
                  </div>
                  <div class="metric-row sub">
                    <span class="label">XIRR:</span>
                    <span class="value"
                      [class.positive]="parseFloat(fund.performance?.oneYear?.dailySip?.xirr || '0') > 0"
                      [class.negative]="parseFloat(fund.performance?.oneYear?.dailySip?.xirr || '0') < 0">
                      {{ fund.performance?.oneYear?.dailySip?.xirr }}
                    </span>
                  </div>
                  <div class="metric-row sub">
                    <span class="label">Avg:</span>
                    <span class="value"
                      [class.positive]="parseFloat(fund.performance?.oneYear?.dailySip?.avg || '0') > 0"
                      [class.negative]="parseFloat(fund.performance?.oneYear?.dailySip?.avg || '0') < 0">
                      {{ fund.performance?.oneYear?.dailySip?.avg }}
                    </span>
                  </div>
                </div>

                <!-- Monthly SIP -->
                <div class="metric-group">
                  <div class="metric-row header">
                    <span class="label">mSIP(2k):</span>
                    <span class="value">{{ fund.performance?.oneYear?.monthlySip?.value }}</span>
                  </div>
                  <div class="metric-row sub">
                    <span class="label">Inv:</span>
                    <span class="value">{{ fund.performance?.oneYear?.monthlySip?.investment }}</span>
                  </div>
                  <div class="metric-row sub">
                    <span class="label">Gain:</span>
                    <span class="value"
                      [class.positive]="parseFloat(fund.performance?.oneYear?.monthlySip?.return || '0') > 0"
                      [class.negative]="parseFloat(fund.performance?.oneYear?.monthlySip?.return || '0') < 0">
                      {{ fund.performance?.oneYear?.monthlySip?.gain }} ({{
                      fund.performance?.oneYear?.monthlySip?.return }})
                    </span>
                  </div>
                  <div class="metric-row sub">
                    <span class="label">XIRR:</span>
                    <span class="value"
                      [class.positive]="parseFloat(fund.performance?.oneYear?.monthlySip?.xirr || '0') > 0"
                      [class.negative]="parseFloat(fund.performance?.oneYear?.monthlySip?.xirr || '0') < 0">
                      {{ fund.performance?.oneYear?.monthlySip?.xirr }}
                    </span>
                  </div>
                  <div class="metric-row sub">
                    <span class="label">Avg:</span>
                    <span class="value"
                      [class.positive]="parseFloat(fund.performance?.oneYear?.monthlySip?.avg || '0') > 0"
                      [class.negative]="parseFloat(fund.performance?.oneYear?.monthlySip?.avg || '0') < 0">
                      {{ fund.performance?.oneYear?.monthlySip?.avg }}
                    </span>
                  </div>
                </div>
              </td>

              <!-- 3 Year -->
              <td class="metrics-cell">
                <div class="metric-row">
                  <span class="label">Avg:</span>
                  <span class="value" [class.positive]="parseFloat(fund.performance?.threeYear?.avg || '0') > 0"
                    [class.negative]="parseFloat(fund.performance?.threeYear?.avg || '0') < 0">
                    {{ fund.performance?.threeYear?.avg }}
                  </span>
                </div>
                <div class="metric-row">
                  <span class="label">Abs:</span>
                  <span class="value" [class.positive]="parseFloat(fund.performance?.threeYear?.abs || '0') > 0"
                    [class.negative]="parseFloat(fund.performance?.threeYear?.abs || '0') < 0">
                    {{ fund.performance?.threeYear?.abs }}
                  </span>
                </div>
                <div class="metric-row">
                  <span class="label">Start:</span>
                  <span class="value">{{ fund.performance?.threeYear?.startNav }}</span>
                </div>
                <div class="metric-row">
                  <span class="label">End:</span>
                  <span class="value">{{ fund.performance?.threeYear?.endNav }}</span>
                </div>

                <!-- Daily SIP -->
                <div class="metric-group">
                  <div class="metric-row header">
                    <span class="label">dSIP(100):</span>
                    <span class="value">{{ fund.performance?.threeYear?.dailySip?.value }}</span>
                  </div>
                  <div class="metric-row sub">
                    <span class="label">Inv:</span>
                    <span class="value">{{ fund.performance?.threeYear?.dailySip?.investment }}</span>
                  </div>
                  <div class="metric-row sub">
                    <span class="label">Gain:</span>
                    <span class="value"
                      [class.positive]="parseFloat(fund.performance?.threeYear?.dailySip?.return || '0') > 0"
                      [class.negative]="parseFloat(fund.performance?.threeYear?.dailySip?.return || '0') < 0">
                      {{ fund.performance?.threeYear?.dailySip?.gain }} ({{
                      fund.performance?.threeYear?.dailySip?.return }})
                    </span>
                  </div>
                  <div class="metric-row sub">
                    <span class="label">XIRR:</span>
                    <span class="value"
                      [class.positive]="parseFloat(fund.performance?.threeYear?.dailySip?.xirr || '0') > 0"
                      [class.negative]="parseFloat(fund.performance?.threeYear?.dailySip?.xirr || '0') < 0">
                      {{ fund.performance?.threeYear?.dailySip?.xirr }}
                    </span>
                  </div>
                  <div class="metric-row sub">
                    <span class="label">Avg:</span>
                    <span class="value"
                      [class.positive]="parseFloat(fund.performance?.threeYear?.dailySip?.avg || '0') > 0"
                      [class.negative]="parseFloat(fund.performance?.threeYear?.dailySip?.avg || '0') < 0">
                      {{ fund.performance?.threeYear?.dailySip?.avg }}
                    </span>
                  </div>
                </div>

                <!-- Monthly SIP -->
                <div class="metric-group">
                  <div class="metric-row header">
                    <span class="label">mSIP(2k):</span>
                    <span class="value">{{ fund.performance?.threeYear?.monthlySip?.value }}</span>
                  </div>
                  <div class="metric-row sub">
                    <span class="label">Inv:</span>
                    <span class="value">{{ fund.performance?.threeYear?.monthlySip?.investment }}</span>
                  </div>
                  <div class="metric-row sub">
                    <span class="label">Gain:</span>
                    <span class="value"
                      [class.positive]="parseFloat(fund.performance?.threeYear?.monthlySip?.return || '0') > 0"
                      [class.negative]="parseFloat(fund.performance?.threeYear?.monthlySip?.return || '0') < 0">
                      {{ fund.performance?.threeYear?.monthlySip?.gain }} ({{
                      fund.performance?.threeYear?.monthlySip?.return }})
                    </span>
                  </div>
                  <div class="metric-row sub">
                    <span class="label">XIRR:</span>
                    <span class="value"
                      [class.positive]="parseFloat(fund.performance?.threeYear?.monthlySip?.xirr || '0') > 0"
                      [class.negative]="parseFloat(fund.performance?.threeYear?.monthlySip?.xirr || '0') < 0">
                      {{ fund.performance?.threeYear?.monthlySip?.xirr }}
                    </span>
                  </div>
                  <div class="metric-row sub">
                    <span class="label">Avg:</span>
                    <span class="value"
                      [class.positive]="parseFloat(fund.performance?.threeYear?.monthlySip?.avg || '0') > 0"
                      [class.negative]="parseFloat(fund.performance?.threeYear?.monthlySip?.avg || '0') < 0">
                      {{ fund.performance?.threeYear?.monthlySip?.avg }}
                    </span>
                  </div>
                </div>
              </td>

              <!-- 5 Year -->
              <td class="metrics-cell">
                <div class="metric-row">
                  <span class="label">Avg:</span>
                  <span class="value" [class.positive]="parseFloat(fund.performance?.fiveYear?.avg || '0') > 0"
                    [class.negative]="parseFloat(fund.performance?.fiveYear?.avg || '0') < 0">
                    {{ fund.performance?.fiveYear?.avg }}
                  </span>
                </div>
                <div class="metric-row">
                  <span class="label">Abs:</span>
                  <span class="value" [class.positive]="parseFloat(fund.performance?.fiveYear?.abs || '0') > 0"
                    [class.negative]="parseFloat(fund.performance?.fiveYear?.abs || '0') < 0">
                    {{ fund.performance?.fiveYear?.abs }}
                  </span>
                </div>
                <div class="metric-row">
                  <span class="label">Start:</span>
                  <span class="value">{{ fund.performance?.fiveYear?.startNav }}</span>
                </div>
                <div class="metric-row">
                  <span class="label">End:</span>
                  <span class="value">{{ fund.performance?.fiveYear?.endNav }}</span>
                </div>

                <!-- Daily SIP -->
                <div class="metric-group">
                  <div class="metric-row header">
                    <span class="label">dSIP(100):</span>
                    <span class="value">{{ fund.performance?.fiveYear?.dailySip?.value }}</span>
                  </div>
                  <div class="metric-row sub">
                    <span class="label">Inv:</span>
                    <span class="value">{{ fund.performance?.fiveYear?.dailySip?.investment }}</span>
                  </div>
                  <div class="metric-row sub">
                    <span class="label">Gain:</span>
                    <span class="value"
                      [class.positive]="parseFloat(fund.performance?.fiveYear?.dailySip?.return || '0') > 0"
                      [class.negative]="parseFloat(fund.performance?.fiveYear?.dailySip?.return || '0') < 0">
                      {{ fund.performance?.fiveYear?.dailySip?.gain }} ({{ fund.performance?.fiveYear?.dailySip?.return
                      }})
                    </span>
                  </div>
                  <div class="metric-row sub">
                    <span class="label">XIRR:</span>
                    <span class="value"
                      [class.positive]="parseFloat(fund.performance?.fiveYear?.dailySip?.xirr || '0') > 0"
                      [class.negative]="parseFloat(fund.performance?.fiveYear?.dailySip?.xirr || '0') < 0">
                      {{ fund.performance?.fiveYear?.dailySip?.xirr }}
                    </span>
                  </div>
                  <div class="metric-row sub">
                    <span class="label">Avg:</span>
                    <span class="value"
                      [class.positive]="parseFloat(fund.performance?.fiveYear?.dailySip?.avg || '0') > 0"
                      [class.negative]="parseFloat(fund.performance?.fiveYear?.dailySip?.avg || '0') < 0">
                      {{ fund.performance?.fiveYear?.dailySip?.avg }}
                    </span>
                  </div>
                </div>

                <!-- Monthly SIP -->
                <div class="metric-group">
                  <div class="metric-row header">
                    <span class="label">mSIP(2k):</span>
                    <span class="value">{{ fund.performance?.fiveYear?.monthlySip?.value }}</span>
                  </div>
                  <div class="metric-row sub">
                    <span class="label">Inv:</span>
                    <span class="value">{{ fund.performance?.fiveYear?.monthlySip?.investment }}</span>
                  </div>
                  <div class="metric-row sub">
                    <span class="label">Gain:</span>
                    <span class="value"
                      [class.positive]="parseFloat(fund.performance?.fiveYear?.monthlySip?.return || '0') > 0"
                      [class.negative]="parseFloat(fund.performance?.fiveYear?.monthlySip?.return || '0') < 0">
                      {{ fund.performance?.fiveYear?.monthlySip?.gain }} ({{
                      fund.performance?.fiveYear?.monthlySip?.return }})
                    </span>
                  </div>
                  <div class="metric-row sub">
                    <span class="label">XIRR:</span>
                    <span class="value"
                      [class.positive]="parseFloat(fund.performance?.fiveYear?.monthlySip?.xirr || '0') > 0"
                      [class.negative]="parseFloat(fund.performance?.fiveYear?.monthlySip?.xirr || '0') < 0">
                      {{ fund.performance?.fiveYear?.monthlySip?.xirr }}
                    </span>
                  </div>
                  <div class="metric-row sub">
                    <span class="label">Avg:</span>
                    <span class="value"
                      [class.positive]="parseFloat(fund.performance?.fiveYear?.monthlySip?.avg || '0') > 0"
                      [class.negative]="parseFloat(fund.performance?.fiveYear?.monthlySip?.avg || '0') < 0">
                      {{ fund.performance?.fiveYear?.monthlySip?.avg }}
                    </span>
                  </div>
                </div>
              </td>

              <!-- Total -->
              <td class="metrics-cell">
                <div class="metric-row">
                  <span class="label">Avg:</span>
                  <span class="value" [class.positive]="parseFloat(fund.performance?.total?.avg || '0') > 0"
                    [class.negative]="parseFloat(fund.performance?.total?.avg || '0') < 0">
                    {{ fund.performance?.total?.avg }}
                  </span>
                </div>
                <div class="metric-row">
                  <span class="label">Abs:</span>
                  <span class="value" [class.positive]="parseFloat(fund.performance?.total?.abs || '0') > 0"
                    [class.negative]="parseFloat(fund.performance?.total?.abs || '0') < 0">
                    {{ fund.performance?.total?.abs }}
                  </span>
                </div>
                <div class="metric-row">
                  <span class="label">Start:</span>
                  <span class="value">{{ fund.performance?.total?.startNav }}</span>
                </div>
                <div class="metric-row">
                  <span class="label">End:</span>
                  <span class="value">{{ fund.performance?.total?.endNav }}</span>
                </div>

                <!-- Daily SIP -->
                <div class="metric-group">
                  <div class="metric-row header">
                    <span class="label">dSIP(100):</span>
                    <span class="value">{{ fund.performance?.total?.dailySip?.value }}</span>
                  </div>
                  <div class="metric-row sub">
                    <span class="label">Inv:</span>
                    <span class="value">{{ fund.performance?.total?.dailySip?.investment }}</span>
                  </div>
                  <div class="metric-row sub">
                    <span class="label">Gain:</span>
                    <span class="value"
                      [class.positive]="parseFloat(fund.performance?.total?.dailySip?.return || '0') > 0"
                      [class.negative]="parseFloat(fund.performance?.total?.dailySip?.return || '0') < 0">
                      {{ fund.performance?.total?.dailySip?.gain }} ({{ fund.performance?.total?.dailySip?.return }})
                    </span>
                  </div>
                  <div class="metric-row sub">
                    <span class="label">XIRR:</span>
                    <span class="value"
                      [class.positive]="parseFloat(fund.performance?.total?.dailySip?.xirr || '0') > 0"
                      [class.negative]="parseFloat(fund.performance?.total?.dailySip?.xirr || '0') < 0">
                      {{ fund.performance?.total?.dailySip?.xirr }}
                    </span>
                  </div>
                  <div class="metric-row sub">
                    <span class="label">Avg:</span>
                    <span class="value" [class.positive]="parseFloat(fund.performance?.total?.dailySip?.avg || '0') > 0"
                      [class.negative]="parseFloat(fund.performance?.total?.dailySip?.avg || '0') < 0">
                      {{ fund.performance?.total?.dailySip?.avg }}
                    </span>
                  </div>
                </div>

                <!-- Monthly SIP -->
                <div class="metric-group">
                  <div class="metric-row header">
                    <span class="label">mSIP(2k):</span>
                    <span class="value">{{ fund.performance?.total?.monthlySip?.value }}</span>
                  </div>
                  <div class="metric-row sub">
                    <span class="label">Inv:</span>
                    <span class="value">{{ fund.performance?.total?.monthlySip?.investment }}</span>
                  </div>
                  <div class="metric-row sub">
                    <span class="label">Gain:</span>
                    <span class="value"
                      [class.positive]="parseFloat(fund.performance?.total?.monthlySip?.return || '0') > 0"
                      [class.negative]="parseFloat(fund.performance?.total?.monthlySip?.return || '0') < 0">
                      {{ fund.performance?.total?.monthlySip?.gain }} ({{ fund.performance?.total?.monthlySip?.return
                      }})
                    </span>
                  </div>
                  <div class="metric-row sub">
                    <span class="label">XIRR:</span>
                    <span class="value"
                      [class.positive]="parseFloat(fund.performance?.total?.monthlySip?.xirr || '0') > 0"
                      [class.negative]="parseFloat(fund.performance?.total?.monthlySip?.xirr || '0') < 0">
                      {{ fund.performance?.total?.monthlySip?.xirr }}
                    </span>
                  </div>
                  <div class="metric-row sub">
                    <span class="label">Avg:</span>
                    <span class="value"
                      [class.positive]="parseFloat(fund.performance?.total?.monthlySip?.avg || '0') > 0"
                      [class.negative]="parseFloat(fund.performance?.total?.monthlySip?.avg || '0') < 0">
                      {{ fund.performance?.total?.monthlySip?.avg }}
                    </span>
                  </div>
                </div>
              </td>

              <!-- Yearly Returns -->
              <td class="metrics-cell">
                <div class="yearly-returns-container">
                  <div class="metric-block" *ngFor="let yearData of fund.yearlyReturns" style="margin-bottom: 8px;">
                    <div class="metric-row">
                      <span class="label">{{ yearData.year }}:</span>
                      <span class="value" [class.positive]="parseFloat(yearData.return) > 0"
                        [class.negative]="parseFloat(yearData.return) < 0">
                        {{ yearData.return }} <span style="color: black;">{{ yearData.startNav }} - {{ yearData.endNav
                          }}</span>
                      </span>
                    </div>
                  </div>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </ion-card>

    <ion-card class="table-card" *ngIf="showSimpleTable">
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Fund Name</th>
              <th class="ion-text-end">Fund Size</th>
              <th class="ion-text-end">Expense Ratio</th>
              <th class="ion-text-end">Exit Load</th>
              <th class="ion-text-end">Min Investment</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let fund of allFundsData">
              <td class="fund-name-cell">
                <div class="fund-name">{{ fund.name }}</div>
                <div class="fund-category" *ngIf="fund.meta">{{ fund.meta.scheme_category }}</div>
              </td>
              <td class="ion-text-end">{{ fund.funSize }}</td>
              <td class="ion-text-end">{{ fund.expenseRatio }}</td>
              <td class="ion-text-end">{{ fund.exitLoad }}</td>
              <td class="ion-text-end">{{ fund.minInvestment }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </ion-card>
  </div>

  <div class="loading-container" *ngIf="isLoading">
    <ion-spinner name="crescent" color="primary"></ion-spinner>
    <p>Fetching market data...</p>
  </div>

  <div *ngIf="!isLoading && allFundsData.length === 0" class="empty-state">
    <ion-icon name="alert-circle-outline"></ion-icon>
    <p>Unable to load fund details.</p>
  </div>

</ion-content>